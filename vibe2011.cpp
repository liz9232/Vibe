#include<stdio.h>
#include <string>
#include <stdlib.h>
#include <cmath>
#include <cassert>
#include <time.h>
#include <exception>
#include "opencv2/imgcodecs.hpp"
#include "opencv2/highgui.hpp"
#include "opencv2/imgproc/imgproc_c.h"
#include "opencv2/imgproc/imgproc.hpp"
#include <opencv2/core/core.hpp>
#include <opencv2/highgui/highgui.hpp>
#include <opencv2/opencv.hpp>
#define random(x) (rand()%(x))
#define w_size 768
#define h_size 576
#define bg_size 20

#define fai 16
#define same_n 2
#define distance_num 20


using namespace cv;
using namespace std;
char forceTimes[w_size * h_size] = { 0 };


//函数封装：模型初始化
//参数：邻域大小，背景模型的数组（引用）方法：
//1.清空背景模型数组
//2.随机选择8联通邻域的值填充到每个像素的背景模型中

void init(uchar background[][bg_size],Mat image) {
	int height = image.rows;
	int width = image.cols;
	cv::Mat image1_(h_size, w_size, CV_8U);
	memset(background, 0, height * width * bg_size);
	srand(unsigned int(time(NULL)));
	uchar temp;
	for (int i = 0; i < height; i++) {
		for (int j = 0; j < width; j++) {			
			if (i - 1 < 0 || j - 1 < 0 || j + 1 >= width || i + 1 >= height) {
				temp = image.at<uchar>(i, j);					
			}
			else {				
				int value = random(8)+1;
				switch (value) {
				case 1: 
					temp = image.at<uchar>(i - 1, j - 1);break;
				case 2: 
					temp = image.at<uchar>(i, j - 1);break;
				case 3:temp = image.at<uchar>(i + 1, j - 1);break;
				case 4: 
					temp = image.at<uchar>(i - 1, j);break;
				case 5: 
					temp = image.at<uchar>(i + 1, j);
					break;
				case 6: temp = image.at<uchar>(i - 1, j + 1);break;
				case 7: temp = image.at<uchar>(i, j + 1);break;
				case 8: temp = image.at<uchar>(i + 1, j + 1);break;
				default:break;
				}				
			}
			image1_.at<uchar>(i, j) = temp;
			
			memset(background[(i * width + j)], temp, bg_size);
			//for (int time = 0; time < bg_size; time++) {
			//	
			//	background[(i * width + j)][time] = temp;
			//	/*background[(i * width + j) * 3 + 1][0] = temp[1];
			//	background[(i * width + j) * 3 + 2][0] = temp[2];*/
			//}
			
		}
	}
	/*imshow("video", image1_);
	imshow("yuantu", image);
	waitKey(88888);*/
	printf("init");	
}

double distance(uchar now_i, uchar rel_i){
	return abs((double)now_i - (double)rel_i) ;
}

double distance(Vec3d now_i, Vec3d rel_i) {
	double sum = 0.0;
	for (int i = 0; i < 3; i++) {
		sum += pow(((double)now_i[i] - (double)rel_i[i]), 2);
	}
	return sqrt(sum)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ;
}
//
//函数封装：判断当前像素点是否属于背景模型
//返回：boolean 属于背景模型否？属于返回true
//参数：当前像素点的值，当前元素位置，背景模型的数组
//方法：
//1.将当前像素的值与当前像素的背景模型内的背景像素点依次对比统计
//2.值的差距在阈值内，计次
//3.计次达到对应阈值，判定为背景，return true
bool isBackground(uchar background[][bg_size], uchar value,int h_now,int w_now) {
	int same_sum = 0;	
	uchar now_i;
	double tempdistance;
	for (int i = 0; i < bg_size; i++) {
		if (h_now * w_size + w_now >= w_size * h_size ) { printf("isBackgroundOver"); return false; }
		now_i = background[(h_now * w_size + w_now)][i];
		tempdistance = distance(now_i, value);
		/*now_i[1] = background[(h_now * width + w_now) * channel_num + 1][i];
		now_i[2] = background[(h_now * width + w_now) * channel_num + 2][i];*/
		if (tempdistance <= (double)distance_num) {
			same_sum++;
		}
		if (same_sum >= same_n){ 
			return true; }
	}
	//printf("isBackground");
	return false;
}
//函数封装：更新模型
//参数：当前像素的位置，当前像素的值，背景模型的数组（引用）
//方法：
//1.随机函数，选择是否插入背景模型
//2.如果插入，随机选择当前像素点背景模型中被替换的点
//3.本元素背景模型被替换后，迭代进行4or8联通邻域更新，调用本函数。
void updateBackground(uchar background[][bg_size], uchar value, int h_now, int w_now, bool check = false) {
	//if (!isBackground(background, value, h_now, w_now) && check) { return; }
	if (h_now < 0 || h_now >= h_size || w_now < 0 || w_now >= w_size) return;
	int location = (h_now * w_size + w_now);
	if (location >= w_size * h_size) { printf("updateBackgroundOver"); return; }
	static int count=0;
	static int random16 = 0;	
	int temp = random(bg_size);
	background[location][temp] = value;
	//以16帧为一组，选定该组内应该插入背景模型的帧序
	if (count % 16 == 0) { random16 = random(16); }	
	if (check) {
	//判断是否是迭代操作，（迭代产生的操作check==False），默认更新八连通
		if (random16 == count%16) {
			//background[location][temp] = value;
			updateBackground(background, value, h_now - 1, w_now - 1);
			updateBackground(background, value, h_now - 1, w_now);
			updateBackground(background, value, h_now - 1, w_now + 1);
			updateBackground(background, value, h_now, w_now - 1);
			updateBackground(background, value, h_now, w_now + 1);
			updateBackground(background, value, h_now + 1, w_now - 1);
			updateBackground(background, value, h_now + 1, w_now);
			updateBackground(background, value, h_now + 1, w_now + 1);
				
		}
		count++;
		//printf("updateBackground_count:%d\n", count);
	}
	
	
	
}

Mat showBackground(uchar background[][bg_size], Mat SrcImage){
	cv::Mat image1_(h_size, w_size, CV_8U);
	for (int i = 0; i < h_size; i++) {
		for (int j = 0; j < w_size; j++) {
			int location = (i * w_size + j) ;
 			if (location >= w_size* h_size) { printf("showBackgroundOver"); return image1_; }
			bool value= isBackground(background, SrcImage.at<uchar>(i, j), i, j);
			
			if (value) {			
				updateBackground(background, SrcImage.at<uchar>(i, j), i, j, true);
				image1_.at<uchar>(i, j) = 0;
			}
			else{
				forceTimes[location]++;
				if (forceTimes[location] > 100) {
					updateBackground(background, SrcImage.at<uchar>(i, j), i, j, true);
					image1_.at<uchar>(i, j) = 0;
				}
				else 
					image1_.at<uchar>(i, j) = 255;				
			}			
		}
	}
	return image1_;
}


int main() {
	//读视频
	std::string video_file = "../../../ImgAndVideoData/vtest.avi";
	VideoCapture cap;
	cap.open(video_file);
	if (!cap.isOpened()) {return 0;}
	int frameRate = cap.get(CV_CAP_PROP_FPS);  //帧率 x frames/s
	cout << "帧率=" << frameRate << endl;

	//读图并重定义大小
	Mat imgFront, imgNow, imgRes;
	cap.read(imgFront);
	if (imgFront.empty()) {return 0;}	
	uchar background[w_size * h_size][bg_size] = { 0};
	cvtColor(imgFront, imgFront, CV_BGR2GRAY);
	init(background, imgFront);
	/*imgRes = showInitBackground(background, imgFront).clone();
	imshow("video", imgRes);
	waitKey(88888);*/
	while (1) {
		cap.read(imgFront);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
		if (imgFront.empty()) { break; }
		
		//printf("times:%d\n", temp);
		//resize(imgNow, imgNow, Size(w_size, h_size));
		cvtColor(imgFront, imgNow, CV_BGR2GRAY);
		imgRes=showBackground(background, imgNow).clone();		
		imshow("video", imgFront);
		imshow("foreground", imgRes);
		waitKey(1000/ frameRate);//每帧延时xx毫秒
		char c = cvWaitKey(5);//显示每一帧之间有5毫秒的间隔
		if (c == 27) break;//如果在这间隔期间用户触发Esc按键 循环就退出 否则继续执行循环
	}
	cap.release();//释放资源
	
}